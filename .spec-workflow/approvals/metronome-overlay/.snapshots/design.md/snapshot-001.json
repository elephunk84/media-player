{
  "id": "snapshot_1762767216514_waltxf2n8",
  "approvalId": "approval_1762767216511_cms28v2f1",
  "approvalTitle": "Design Document - Metronome Overlay Feature",
  "version": 1,
  "timestamp": "2025-11-10T09:33:36.514Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe Metronome Overlay feature integrates a synchronized audio and visual metronome system into the existing Video.js-based video player. The design follows the project's modular architecture by creating isolated, reusable components with clear separation of concerns. The metronome operates independently yet synchronizes with video playback state (play/pause/seek) through the existing `useVideoPlayer` hook.\n\nThe implementation consists of four primary layers:\n1. **Core Engine Layer**: Timing engine using Web Audio API for precision beat scheduling\n2. **Audio Layer**: Configurable audio playback with multiple sound options and volume control\n3. **Visual Layer**: Pluggable visual effect renderers (flash, pulse, border, custom shapes)\n4. **UI Layer**: Settings panel integrated into VideoPlayer with real-time controls\n\nThis architecture ensures the metronome can be easily tested, extended, and maintained independently of the video player while providing seamless integration.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n_Note: No steering documents exist yet. This design follows established patterns found in the codebase:_\n\n- **TypeScript Strict Mode**: Full type safety with interfaces for all configurations\n- **React Functional Components**: All components use hooks, no class components\n- **Custom Hooks Pattern**: Follows the existing `useVideoPlayer` pattern for state management\n- **CSS Modules/Scoped Styles**: Component-specific CSS files matching existing `VideoPlayer.css` pattern\n- **Error Handling**: Graceful degradation with user-friendly error messages\n- **Testing**: Unit tests for hooks/utilities, component tests for React components, E2E tests for workflows\n\n### Project Structure (structure.md)\n\n_Note: No steering documents exist yet. This design follows the existing project organization:_\n\nThe implementation will follow the established frontend structure:\n```\nfrontend/src/\n├── components/\n│   ├── VideoPlayer.tsx (existing - will be modified)\n│   ├── MetronomeOverlay.tsx (new)\n│   ├── MetronomeControls.tsx (new)\n│   ├── MetronomeSettingsPanel.tsx (new)\n│   └── visualEffects/ (new directory)\n│       ├── FlashEffect.tsx\n│       ├── PulseEffect.tsx\n│       ├── BorderEffect.tsx\n│       └── VisualEffectFactory.tsx\n├── hooks/\n│   ├── useVideoPlayer.ts (existing - no changes)\n│   ├── useMetronome.ts (new)\n│   ├── useMetronomeAudio.ts (new)\n│   ├── useMetronomeVisuals.ts (new)\n│   └── useMetronomePresets.ts (new)\n├── services/\n│   ├── metronome/\n│   │   ├── MetronomeEngine.ts (new - core timing logic)\n│   │   ├── AudioScheduler.ts (new - Web Audio API wrapper)\n│   │   ├── PatternManager.ts (new - pattern processing)\n│   │   └── PresetStorage.ts (new - localStorage management)\n├── types/\n│   └── metronome.ts (new - all TypeScript interfaces)\n└── utils/\n    └── metronome/\n        ├── timingCalculations.ts (new - BPM/timing math)\n        └── audioLoader.ts (new - custom sound loading)\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **useVideoPlayer Hook**:\n  - **Reuse**: Subscribe to `playing`, `currentTime`, and player events\n  - **Integration**: Metronome will listen to play/pause/seek events to sync timing\n  - **No Modifications**: Hook remains unchanged, metronome consumes its state\n\n- **VideoPlayer Component**:\n  - **Modification**: Add `<MetronomeOverlay />` as a sibling to the video element\n  - **Integration**: Pass `playerInstance` to metronome for state synchronization\n  - **Pattern**: Similar to how loading/error overlays are currently rendered\n\n- **localStorage Pattern**:\n  - **Reuse**: Existing pattern for persisting user preferences (seen in auth/user contexts)\n  - **Implementation**: Store presets and last-used settings in `localStorage`\n  - **Key Prefix**: Use `metronome_` prefix for all storage keys\n\n- **CSS Overlay Pattern**:\n  - **Reuse**: Existing overlay patterns from `VideoPlayer.css` (loading, error overlays)\n  - **Extend**: Apply similar positioning/z-index strategies for visual effects\n  - **Style**: Match existing component styling conventions\n\n- **TypeScript Interfaces**:\n  - **Pattern**: Follow existing type definition patterns from `types/video.ts`\n  - **Naming**: Use similar conventions (PascalCase for interfaces, camelCase for properties)\n  - **Structure**: Group related interfaces in single `types/metronome.ts` file\n\n### Integration Points\n\n- **VideoPlayer Component**: Metronome overlay will be rendered within VideoPlayer's container, listening to player state changes\n- **Browser localStorage**: Presets and settings persisted using localStorage API (5MB limit enforcement)\n- **Web Audio API**: Core timing engine uses AudioContext for sub-millisecond accuracy\n- **React Context (Optional)**: May use Context for sharing metronome state across deeply nested components if needed\n- **Keyboard Events**: Integrate with existing keyboard shortcut system in VideoPlayer component\n\n## Architecture\n\nThe metronome system follows a **layered architecture** with clear separation of concerns:\n\n### Layer 1: Core Timing Engine\n- **Responsibility**: Maintain accurate beat timing independent of React render cycles\n- **Technology**: Web Audio API's `AudioContext.currentTime` for scheduling\n- **Pattern**: Event emitter pattern for beat notifications\n- **Isolation**: Pure TypeScript class, no React dependencies\n\n### Layer 2: Audio & Visual Renderers\n- **Responsibility**: Respond to beat events by playing sounds or rendering visuals\n- **Pattern**: Strategy pattern - pluggable renderers implement common interface\n- **Audio**: Web Audio API for sound playback with pre-loaded audio buffers\n- **Visual**: React components that render effects (Flash, Pulse, Border, Custom)\n\n### Layer 3: React Integration Hooks\n- **Responsibility**: Connect timing engine to React component lifecycle\n- **Pattern**: Custom hooks manage engine lifecycle and expose state/controls\n- **State Management**: useState/useReducer for metronome configuration\n- **Side Effects**: useEffect for engine initialization/cleanup and video sync\n\n### Layer 4: UI Components\n- **Responsibility**: User controls and settings interface\n- **Pattern**: Presentational components receive props from container components\n- **State**: Controlled components with immediate feedback (no save button)\n\n### Architecture Diagram\n\n```mermaid\ngraph TB\n    subgraph \"UI Layer - React Components\"\n        A[MetronomeOverlay] --> B[MetronomeSettingsPanel]\n        A --> C[VisualEffectRenderer]\n        B --> D[MetronomeControls]\n    end\n\n    subgraph \"Hook Layer - React State Management\"\n        E[useMetronome] --> F[useMetronomeAudio]\n        E --> G[useMetronomeVisuals]\n        E --> H[useMetronomePresets]\n    end\n\n    subgraph \"Service Layer - Core Logic\"\n        I[MetronomeEngine] --> J[AudioScheduler]\n        I --> K[PatternManager]\n        H --> L[PresetStorage]\n    end\n\n    subgraph \"External Dependencies\"\n        M[useVideoPlayer Hook]\n        N[Web Audio API]\n        O[localStorage API]\n    end\n\n    A --> E\n    D --> E\n    E --> I\n    F --> J\n    G --> C\n    H --> L\n    J --> N\n    L --> O\n    E -.sync.-> M\n    I -.events.-> F\n    I -.events.-> G\n\n    style I fill:#e1f5fe\n    style J fill:#e1f5fe\n    style K fill:#e1f5fe\n    style L fill:#e1f5fe\n    style M fill:#fff3e0\n    style N fill:#fff3e0\n    style O fill:#fff3e0\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**:\n  - `MetronomeEngine.ts`: Only timing calculations and beat scheduling\n  - `AudioScheduler.ts`: Only audio playback logic\n  - `PatternManager.ts`: Only pattern sequence processing\n  - `useMetronome.ts`: Only top-level metronome state orchestration\n  - `useMetronomeAudio.ts`: Only audio state and controls\n  - `useMetronomeVisuals.ts`: Only visual effect state and rendering\n\n- **Component Isolation**:\n  - Each visual effect (Flash, Pulse, Border) is a separate React component\n  - Settings panel sections split into sub-components (BPM Controls, Pattern Editor, Visual Settings, Audio Settings)\n  - MetronomeOverlay acts as container, delegates to specialized components\n\n- **Service Layer Separation**:\n  - Core timing engine has zero React dependencies (pure TypeScript)\n  - Audio/Visual renderers are thin wrappers over engine events\n  - Preset storage isolated in dedicated service with clear CRUD interface\n\n- **Utility Modularity**:\n  - Timing calculations (BPM ↔ milliseconds conversions) in pure functions\n  - Audio loading/validation in separate utility module\n  - Pattern validation and transformation in pure functions\n\n## Components and Interfaces\n\n### Component 1: MetronomeEngine (Service)\n\n- **Purpose**: Core timing engine that schedules beats with high precision using Web Audio API\n- **File**: `frontend/src/services/metronome/MetronomeEngine.ts`\n- **Pattern**: Event Emitter (Observable)\n- **Interfaces**:\n  ```typescript\n  class MetronomeEngine {\n    start(config: MetronomeConfig): void\n    stop(): void\n    pause(): void\n    resume(): void\n    updateBPM(bpm: number): void\n    updatePattern(pattern: BeatPattern): void\n    on(event: 'beat', callback: (beatInfo: BeatInfo) => void): void\n    off(event: 'beat', callback: Function): void\n    getCurrentBeat(): number\n    dispose(): void\n  }\n  ```\n- **Dependencies**: Web Audio API (AudioContext)\n- **Reuses**: None (foundational component)\n- **Key Logic**:\n  - Uses `AudioContext.currentTime` for scheduling beats in advance (look-ahead scheduling)\n  - Maintains accurate timing even when main thread is busy\n  - Emits `beat` events with beat number, intensity, and timing information\n\n### Component 2: AudioScheduler (Service)\n\n- **Purpose**: Manages audio buffer loading and playback for metronome sounds\n- **File**: `frontend/src/services/metronome/AudioScheduler.ts`\n- **Interfaces**:\n  ```typescript\n  class AudioScheduler {\n    constructor(audioContext: AudioContext)\n    loadSound(soundType: SoundType): Promise<void>\n    loadCustomSound(file: File): Promise<void>\n    playBeat(intensity: number, volume: number, time: number): void\n    setMasterVolume(volume: number): void\n    dispose(): void\n  }\n  ```\n- **Dependencies**: Web Audio API (AudioContext, AudioBuffer)\n- **Reuses**: `frontend/src/utils/metronome/audioLoader.ts` for loading sound files\n- **Key Logic**:\n  - Pre-loads audio buffers for all sound types (click, beep, drum, snap, woodblock)\n  - Uses AudioBufferSourceNode for precise timing\n  - Applies gain nodes for volume control per beat intensity\n\n### Component 3: PatternManager (Service)\n\n- **Purpose**: Processes and validates beat patterns, calculates beat sequences\n- **File**: `frontend/src/services/metronome/PatternManager.ts`\n- **Interfaces**:\n  ```typescript\n  class PatternManager {\n    validatePattern(pattern: BeatPattern): ValidationResult\n    calculateNextBeat(currentBeat: number, pattern: BeatPattern): BeatInfo\n    applyRandomization(beatTime: number, randomization: number): number\n    applyTempoChange(currentBPM: number, config: TempoChangeConfig): number\n  }\n  ```\n- **Dependencies**: None (pure logic)\n- **Reuses**: `frontend/src/utils/metronome/timingCalculations.ts`\n- **Key Logic**:\n  - Validates pattern array (length, intensity values)\n  - Calculates next beat in sequence with intensity from pattern\n  - Applies timing randomization within configured bounds\n  - Handles tempo acceleration/deceleration\n\n### Component 4: useMetronome (React Hook)\n\n- **Purpose**: Top-level hook orchestrating metronome state and synchronization with video player\n- **File**: `frontend/src/hooks/useMetronome.ts`\n- **Interfaces**:\n  ```typescript\n  function useMetronome(playerState: UseVideoPlayerReturn): UseMetronomeReturn {\n    // Returns state and control methods\n  }\n\n  interface UseMetronomeReturn {\n    // State\n    enabled: boolean\n    config: MetronomeConfig\n    currentBeat: number\n\n    // Controls\n    toggle: () => void\n    updateConfig: (partial: Partial<MetronomeConfig>) => void\n    start: () => void\n    stop: () => void\n\n    // Engine reference\n    engineRef: React.MutableRefObject<MetronomeEngine | null>\n  }\n  ```\n- **Dependencies**: MetronomeEngine, useVideoPlayer (passed as parameter)\n- **Reuses**: Existing `useVideoPlayer` hook state for synchronization\n- **Key Logic**:\n  - Initializes MetronomeEngine on mount, disposes on unmount\n  - Listens to `playerState.playing` to auto-pause/resume metronome\n  - Syncs metronome with video.currentTime on seek events\n  - Manages metronome configuration state (BPM, pattern, etc.)\n\n### Component 5: useMetronomeAudio (React Hook)\n\n- **Purpose**: Manages audio-specific state and connects AudioScheduler to beat events\n- **File**: `frontend/src/hooks/useMetronomeAudio.ts`\n- **Interfaces**:\n  ```typescript\n  function useMetronomeAudio(\n    engineRef: React.MutableRefObject<MetronomeEngine | null>,\n    config: AudioConfig\n  ): UseMetronomeAudioReturn\n\n  interface UseMetronomeAudioReturn {\n    audioScheduler: React.MutableRefObject<AudioScheduler | null>\n    loadingSound: boolean\n    audioError: string | null\n    setVolume: (volume: number) => void\n    setSoundType: (type: SoundType) => void\n    loadCustomSound: (file: File) => Promise<void>\n  }\n  ```\n- **Dependencies**: AudioScheduler, MetronomeEngine\n- **Reuses**: None (new functionality)\n- **Key Logic**:\n  - Creates AudioScheduler instance with Web Audio API\n  - Subscribes to MetronomeEngine's `beat` events\n  - Plays appropriate sound based on beat intensity and config\n  - Handles sound loading errors gracefully\n\n### Component 6: useMetronomeVisuals (React Hook)\n\n- **Purpose**: Manages visual effect state and triggers visual renderers on beats\n- **File**: `frontend/src/hooks/useMetronomeVisuals.ts`\n- **Interfaces**:\n  ```typescript\n  function useMetronomeVisuals(\n    engineRef: React.MutableRefObject<MetronomeEngine | null>,\n    config: VisualConfig\n  ): UseMetronomeVisualsReturn\n\n  interface UseMetronomeVisualsReturn {\n    activeEffect: BeatEffect | null\n    updateVisualConfig: (config: Partial<VisualConfig>) => void\n  }\n\n  interface BeatEffect {\n    intensity: number\n    timestamp: number\n    duration: number\n  }\n  ```\n- **Dependencies**: MetronomeEngine\n- **Reuses**: None (new functionality)\n- **Key Logic**:\n  - Subscribes to MetronomeEngine's `beat` events\n  - Sets `activeEffect` state triggering visual component renders\n  - Automatically clears effect after beat duration (prevents overlap)\n  - Provides visual config update methods\n\n### Component 7: useMetronomePresets (React Hook)\n\n- **Purpose**: Manages preset CRUD operations with localStorage persistence\n- **File**: `frontend/src/hooks/useMetronomePresets.ts`\n- **Interfaces**:\n  ```typescript\n  function useMetronomePresets(): UseMetronomePresetsReturn\n\n  interface UseMetronomePresetsReturn {\n    presets: MetronomePreset[]\n    savePreset: (name: string, config: MetronomeConfig) => void\n    loadPreset: (id: string) => MetronomeConfig | null\n    deletePreset: (id: string) => void\n    exportPresets: () => string\n    importPresets: (json: string) => ValidationResult\n  }\n  ```\n- **Dependencies**: PresetStorage service\n- **Reuses**: localStorage API (browser standard)\n- **Key Logic**:\n  - Loads presets from localStorage on mount\n  - Validates preset structure before save/load\n  - Generates JSON export with all presets\n  - Validates and imports JSON presets (with error handling)\n  - Enforces 5MB localStorage limit\n\n### Component 8: MetronomeOverlay (React Component)\n\n- **Purpose**: Top-level container component that renders metronome UI and effects\n- **File**: `frontend/src/components/MetronomeOverlay.tsx`\n- **Interfaces**:\n  ```typescript\n  interface MetronomeOverlayProps {\n    playerState: UseVideoPlayerReturn\n    initialConfig?: Partial<MetronomeConfig>\n  }\n  ```\n- **Dependencies**: useMetronome, useMetronomeAudio, useMetronomeVisuals, MetronomeSettingsPanel, VisualEffectRenderer\n- **Reuses**: Existing overlay positioning patterns from VideoPlayer.css\n- **Key Logic**:\n  - Orchestrates all metronome hooks\n  - Conditionally renders settings panel (collapsed/expanded)\n  - Renders visual effects based on useMetronomeVisuals state\n  - Provides toggle button in video controls\n\n### Component 9: MetronomeSettingsPanel (React Component)\n\n- **Purpose**: Main settings UI with tabs/sections for all metronome configuration\n- **File**: `frontend/src/components/MetronomeSettingsPanel.tsx`\n- **Interfaces**:\n  ```typescript\n  interface MetronomeSettingsPanelProps {\n    config: MetronomeConfig\n    onConfigChange: (config: Partial<MetronomeConfig>) => void\n    presets: MetronomePreset[]\n    onLoadPreset: (id: string) => void\n    onSavePreset: (name: string) => void\n  }\n  ```\n- **Dependencies**: MetronomeControls, sub-components for each settings section\n- **Reuses**: Similar panel structure to other settings UIs in the app\n- **Key Logic**:\n  - Tabbed/sectioned layout (Basic, Pattern, Visual, Audio, Presets)\n  - All controls are controlled components (real-time updates)\n  - Validates inputs before applying (BPM range, pattern length, etc.)\n  - Responsive design (sidebar on desktop, overlay on mobile)\n\n### Component 10: VisualEffectRenderer (React Component)\n\n- **Purpose**: Factory component that renders the appropriate visual effect based on config\n- **File**: `frontend/src/components/MetronomeVisualEffects.tsx`\n- **Interfaces**:\n  ```typescript\n  interface VisualEffectRendererProps {\n    effect: BeatEffect | null\n    config: VisualConfig\n  }\n  ```\n- **Dependencies**: FlashEffect, PulseEffect, BorderEffect components\n- **Reuses**: None (new functionality)\n- **Key Logic**:\n  - Renders nothing if `effect === null`\n  - Selects effect component based on `config.visualStyle`\n  - Passes intensity and config to selected effect component\n  - Uses CSS transitions/animations for smooth effects\n\n### Component 11: Visual Effect Components (React Components)\n\n- **Purpose**: Individual effect renderers (Flash, Pulse, Border, Custom)\n- **Files**:\n  - `frontend/src/components/visualEffects/FlashEffect.tsx`\n  - `frontend/src/components/visualEffects/PulseEffect.tsx`\n  - `frontend/src/components/visualEffects/BorderEffect.tsx`\n- **Interfaces**:\n  ```typescript\n  interface EffectProps {\n    intensity: number // 0-1\n    duration: number // milliseconds\n    config: VisualConfig\n  }\n  ```\n- **Dependencies**: None (pure presentational components)\n- **Reuses**: None (new functionality)\n- **Key Logic**:\n  - **FlashEffect**: Renders full-screen overlay with opacity based on intensity\n  - **PulseEffect**: Renders expanding/contracting shape at configured position\n  - **BorderEffect**: Renders colored border around video with thickness based on intensity\n  - All use CSS animations with `duration` prop for timing\n\n## Data Models\n\n### MetronomeConfig\n\n```typescript\ninterface MetronomeConfig {\n  // Basic timing\n  bpm: number // 30-300\n  enabled: boolean\n\n  // Pattern\n  pattern: BeatPattern\n  patternEnabled: boolean\n\n  // Randomization\n  randomization: number // 0-50 (percentage)\n  randomizationEnabled: boolean\n\n  // Tempo change\n  tempoChange: TempoChangeConfig\n  tempoChangeEnabled: boolean\n\n  // Audio\n  audio: AudioConfig\n\n  // Visual\n  visual: VisualConfig\n\n  // Sync\n  syncToVideo: boolean\n  continuousMode: boolean // Continue between playlist items\n}\n```\n\n### BeatPattern\n\n```typescript\ninterface BeatPattern {\n  beats: BeatIntensity[] // Array of 2-32 beats\n  length: number // Number of beats in pattern (2-32)\n  accentBeat: number | null // Which beat to accent (1-based, null = none)\n}\n\ntype BeatIntensity = 'light' | 'medium' | 'strong' | 'silent'\n\n// Internal representation\ninterface BeatInfo {\n  beatNumber: number // Current beat in pattern (0-based)\n  intensity: BeatIntensity\n  volume: number // Calculated volume (0-1)\n  timestamp: number // AudioContext.currentTime\n}\n```\n\n### TempoChangeConfig\n\n```typescript\ninterface TempoChangeConfig {\n  mode: 'accelerate' | 'decelerate' | 'cycle'\n  changePerMinute: number // BPM change per real-time minute\n  minBPM: number // Lower bound\n  maxBPM: number // Upper bound\n  resetOnStop: boolean // Reset to initial BPM when stopped\n}\n```\n\n### AudioConfig\n\n```typescript\ninterface AudioConfig {\n  soundType: SoundType\n  customSoundUrl: string | null // Data URL for custom sound\n  masterVolume: number // 0-1\n  muted: boolean\n  volumeVariation: boolean // Vary volume by intensity\n  volumeMap: {\n    silent: 0\n    light: number // Default 0.25\n    medium: number // Default 0.5\n    strong: number // Default 1.0\n  }\n}\n\ntype SoundType = 'click' | 'beep' | 'drum' | 'snap' | 'woodblock' | 'custom'\n```\n\n### VisualConfig\n\n```typescript\ninterface VisualConfig {\n  enabled: boolean\n  visualStyle: VisualStyle\n  color: string // Hex color\n  opacity: number // 0-1\n  size: number // Percentage of screen (10-100)\n  position: Position\n  shape: Shape // For pulse effect\n  multiOverlay: boolean // Show multiple overlays simultaneously\n}\n\ntype VisualStyle = 'flash' | 'pulse' | 'border' | 'none'\n\ninterface Position {\n  x: number // 0-100 (percentage)\n  y: number // 0-100 (percentage)\n  preset: 'center' | 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right' | 'custom'\n}\n\ntype Shape = 'circle' | 'square' | 'diamond' | 'star'\n```\n\n### MetronomePreset\n\n```typescript\ninterface MetronomePreset {\n  id: string // UUID\n  name: string // User-defined name (max 50 chars)\n  description: string | null // Optional description\n  config: MetronomeConfig\n  createdAt: string // ISO timestamp\n  updatedAt: string // ISO timestamp\n}\n```\n\n### MetronomeState (Internal)\n\n```typescript\ninterface MetronomeState {\n  // Runtime state (not persisted)\n  initialized: boolean\n  running: boolean\n  currentBeat: number\n  lastBeatTimestamp: number | null\n  error: string | null\n\n  // Synchronized from video player\n  videoPlaying: boolean\n  videoCurrentTime: number\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Web Audio API Unavailable**\n   - **Handling**: Detect AudioContext support on initialization, fallback to setTimeout-based timing\n   - **User Impact**: Warning message: \"High-precision audio not supported. Timing may be less accurate.\"\n   - **Degradation**: Visual effects continue, audio uses fallback scheduler\n   - **Recovery**: None (browser limitation)\n\n2. **Audio File Loading Failure**\n   - **Handling**: Catch errors from `AudioContext.decodeAudioData()`, display error message\n   - **User Impact**: Error notification: \"Failed to load sound: [filename]. Using default click sound.\"\n   - **Degradation**: Fallback to default 'click' sound\n   - **Recovery**: User can retry loading or select different sound\n\n3. **Custom Sound File Invalid**\n   - **Handling**: Validate file type (WAV/MP3/OGG) and size (<5MB) before loading\n   - **User Impact**: Error message: \"Invalid audio file. Must be WAV, MP3, or OGG under 5MB.\"\n   - **Degradation**: Reject file, keep current sound setting\n   - **Recovery**: User selects valid audio file\n\n4. **localStorage Quota Exceeded**\n   - **Handling**: Catch `QuotaExceededError` when saving presets\n   - **User Impact**: Error message: \"Storage limit reached. Delete unused presets to save new ones.\"\n   - **Degradation**: Preset not saved, existing presets remain\n   - **Recovery**: User deletes old presets to free space\n\n5. **Pattern Validation Failure**\n   - **Handling**: Validate pattern length (2-32) and intensity values before applying\n   - **User Impact**: Inline error message in pattern editor: \"Pattern must have 2-32 beats\"\n   - **Degradation**: Invalid pattern rejected, current pattern continues\n   - **Recovery**: User corrects pattern configuration\n\n6. **Preset Import JSON Invalid**\n   - **Handling**: Try-catch JSON parsing, validate schema against MetronomePreset interface\n   - **User Impact**: Error message: \"Invalid preset file. Unable to import.\"\n   - **Degradation**: Import cancelled, existing presets unchanged\n   - **Recovery**: User provides valid JSON file\n\n7. **Video Player Reference Lost**\n   - **Handling**: Check `playerState.playerRef.current` before accessing Video.js API\n   - **User Impact**: Metronome stops gracefully, no error shown (video player cleanup)\n   - **Degradation**: Metronome disabled until player re-initialized\n   - **Recovery**: Automatic on next video load\n\n8. **Timing Drift Detection**\n   - **Handling**: Monitor actual beat timing vs expected, reset scheduler if drift >20ms\n   - **User Impact**: Brief pause/hiccup (1-2 beats) while re-synchronizing\n   - **Degradation**: Temporary timing disruption\n   - **Recovery**: Automatic recalibration\n\n9. **Browser Tab Backgrounded**\n   - **Handling**: Detect `visibilitychange` event, warn if high CPU usage detected\n   - **User Impact**: Possible timing degradation warning: \"Metronome timing may be affected in background tabs\"\n   - **Degradation**: Timing accuracy may decrease (browser throttling)\n   - **Recovery**: Return tab to foreground\n\n10. **Preset Name Collision**\n    - **Handling**: Check for duplicate names before saving, offer to overwrite or rename\n    - **User Impact**: Confirmation dialog: \"Preset '[name]' already exists. Overwrite?\"\n    - **Degradation**: None (preventative)\n    - **Recovery**: User chooses to overwrite or provide different name\n\n## Testing Strategy\n\n### Unit Testing\n\n**Target Coverage**: >80% for all service layer and utility functions\n\n**Tools**: Jest, @testing-library/react-hooks\n\n**Key Components to Test**:\n\n1. **MetronomeEngine**:\n   - Beat timing accuracy (mock AudioContext.currentTime)\n   - Pattern sequence generation\n   - BPM changes apply correctly\n   - Event emission on beats\n   - Pause/resume state management\n   - Cleanup (dispose) releases resources\n\n2. **AudioScheduler**:\n   - Audio buffer loading (mock fetch)\n   - Volume calculations based on intensity\n   - Master volume application\n   - Scheduled playback timing (mock AudioContext)\n   - Error handling for invalid audio files\n\n3. **PatternManager**:\n   - Pattern validation (length, intensity values)\n   - Next beat calculation in sequence\n   - Randomization within bounds\n   - Tempo acceleration/deceleration calculations\n   - Edge cases (1-beat patterns, accent on last beat)\n\n4. **Timing Utilities** (`timingCalculations.ts`):\n   - BPM to milliseconds conversion (60 BPM = 1000ms)\n   - Beat duration with randomization\n   - Tempo change calculations\n   - Edge cases (30 BPM min, 300 BPM max)\n\n5. **PresetStorage**:\n   - Save/load/delete operations (mock localStorage)\n   - JSON export format correctness\n   - JSON import validation (reject malformed data)\n   - localStorage quota handling\n\n6. **Custom Hooks** (`useMetronome`, `useMetronomeAudio`, `useMetronomeVisuals`, `useMetronomePresets`):\n   - State updates on configuration changes\n   - Cleanup on unmount (engine disposed)\n   - Video player synchronization (play/pause/seek)\n   - Effect subscriptions and unsubscriptions\n   - Error state propagation\n\n**Test Example**:\n```typescript\ndescribe('MetronomeEngine', () => {\n  it('emits beat events at correct intervals for 120 BPM', () => {\n    const engine = new MetronomeEngine(mockAudioContext);\n    const beatTimes: number[] = [];\n\n    engine.on('beat', (info) => beatTimes.push(info.timestamp));\n    engine.start({ bpm: 120, pattern: defaultPattern });\n\n    // Advance mock timer\n    jest.advanceTimersByTime(1000);\n\n    // 120 BPM = 500ms per beat, expect 2 beats in 1000ms\n    expect(beatTimes.length).toBe(2);\n    expect(beatTimes[1] - beatTimes[0]).toBeCloseTo(0.5, 2); // 500ms\n  });\n});\n```\n\n### Integration Testing\n\n**Target Coverage**: All major integration points\n\n**Tools**: Jest, @testing-library/react\n\n**Key Flows to Test**:\n\n1. **Metronome + Video Player Integration**:\n   - Metronome starts when video plays\n   - Metronome pauses when video pauses\n   - Metronome re-syncs on video seek\n   - Metronome respects video playback rate changes\n   - Metronome stops when video ends (unless continuous mode)\n\n2. **Audio + Visual Synchronization**:\n   - Audio and visual effects trigger on same beat\n   - Intensity affects both audio volume and visual brightness\n   - Pattern changes reflect in both audio and visual\n   - Muting audio doesn't stop visual effects\n\n3. **Settings Panel + Engine Updates**:\n   - BPM slider changes update engine in real-time\n   - Pattern editor changes apply immediately\n   - Preset loading updates all settings\n   - Visual config changes render new effects\n\n4. **Preset Management Flow**:\n   - Save preset persists all current settings\n   - Load preset restores settings correctly\n   - Delete preset removes from localStorage\n   - Export generates valid JSON\n   - Import validates and loads JSON presets\n\n5. **Error Recovery Flows**:\n   - Audio loading failure falls back to default sound\n   - Invalid preset import doesn't corrupt existing data\n   - localStorage quota error doesn't crash app\n   - Video player disposal doesn't break metronome cleanup\n\n**Test Example**:\n```typescript\ndescribe('Metronome Video Player Integration', () => {\n  it('pauses metronome when video is paused', () => {\n    const { result: playerResult } = renderHook(() => useVideoPlayer());\n    const { result: metronomeResult } = renderHook(() =>\n      useMetronome(playerResult.current)\n    );\n\n    // Start metronome\n    act(() => metronomeResult.current.start());\n    expect(metronomeResult.current.engineRef.current?.isRunning()).toBe(true);\n\n    // Pause video (simulate Video.js pause event)\n    act(() => playerResult.current.pause());\n\n    // Metronome should auto-pause\n    expect(metronomeResult.current.engineRef.current?.isRunning()).toBe(false);\n  });\n});\n```\n\n### End-to-End Testing\n\n**Target Coverage**: Complete user workflows from discovery to usage\n\n**Tools**: Playwright\n\n**User Scenarios to Test**:\n\n1. **First-Time User Workflow**:\n   - User opens video player\n   - User clicks metronome button in controls\n   - Settings panel opens with defaults (60 BPM, click sound, flash effect)\n   - User clicks \"Start\" (or video auto-starts metronome)\n   - Audio beats play in sync with visual flashes\n   - User adjusts BPM slider → beats update in real-time\n\n2. **Custom Pattern Creation**:\n   - User enables pattern mode\n   - User creates pattern: [strong, medium, medium, light]\n   - User previews pattern (plays without video)\n   - User applies pattern → metronome plays sequence repeatedly\n   - Audio volume and visual intensity vary per beat\n\n3. **Preset Management**:\n   - User configures custom settings (90 BPM, pulse effect, drum sound, pattern)\n   - User clicks \"Save Preset\" → enters name \"Workout Rhythm\"\n   - User changes settings\n   - User loads \"Workout Rhythm\" preset → all settings restored\n   - User deletes preset → confirmation dialog → preset removed\n\n4. **Playlist Playback**:\n   - User starts playlist with metronome enabled\n   - Metronome plays through first clip\n   - Clip transitions to second clip\n   - Metronome continues without interruption (continuous mode)\n   - User disables continuous mode → metronome stops between clips\n\n5. **Advanced Customization**:\n   - User selects pulse effect with custom color (red)\n   - User adjusts size to 50% and position to top-right\n   - User enables tempo acceleration (+10 BPM per minute)\n   - Metronome starts at 60 BPM, gradually increases to 90 BPM over 3 minutes\n   - Visual pulse grows/shrinks with beats in top-right corner (red)\n\n6. **Error Scenarios**:\n   - User attempts to load invalid custom sound → error message displayed, defaults to click\n   - User tries to save 11th preset (storage limit) → error message, prompt to delete old presets\n   - User imports malformed JSON → error notification, existing presets unchanged\n\n7. **Accessibility Testing**:\n   - User navigates metronome controls using only keyboard (Tab, Enter, Space)\n   - Screen reader announces metronome state (\"Metronome enabled, 120 BPM\")\n   - Focus indicators visible on all interactive elements\n   - Settings panel closable with Escape key\n\n**Test Example** (Playwright):\n```typescript\ntest('User can create and load custom preset', async ({ page }) => {\n  // Navigate to video player\n  await page.goto('/videos/1');\n\n  // Open metronome settings\n  await page.click('[data-testid=\"metronome-toggle\"]');\n\n  // Configure settings\n  await page.fill('[data-testid=\"bpm-input\"]', '120');\n  await page.selectOption('[data-testid=\"sound-select\"]', 'drum');\n  await page.selectOption('[data-testid=\"visual-style\"]', 'pulse');\n\n  // Save preset\n  await page.click('[data-testid=\"save-preset-btn\"]');\n  await page.fill('[data-testid=\"preset-name-input\"]', 'Test Preset');\n  await page.click('[data-testid=\"confirm-save-btn\"]');\n\n  // Verify preset appears in list\n  await expect(page.locator('text=Test Preset')).toBeVisible();\n\n  // Change settings\n  await page.fill('[data-testid=\"bpm-input\"]', '90');\n\n  // Load preset\n  await page.click('[data-testid=\"preset-Test Preset\"]');\n\n  // Verify settings restored\n  await expect(page.locator('[data-testid=\"bpm-input\"]')).toHaveValue('120');\n  await expect(page.locator('[data-testid=\"sound-select\"]')).toHaveValue('drum');\n});\n```\n\n### Performance Testing\n\n**Tools**: Chrome DevTools Performance Profiler, Lighthouse\n\n**Metrics to Monitor**:\n\n1. **Timing Accuracy**: Beat timing deviation from expected (target: <±5ms)\n2. **Frame Rate**: Visual effects should not drop below 60fps\n3. **CPU Usage**: Metronome should use <5% CPU during normal operation\n4. **Memory**: No memory leaks over 30-minute session\n5. **Startup Time**: Metronome initialization <100ms\n6. **Pattern Processing**: 32-beat pattern processing <10ms\n\n**Test Approach**:\n- Run metronome for 10 minutes, log all beat timestamps\n- Calculate standard deviation of beat intervals\n- Monitor CPU and memory usage in Performance profiler\n- Use `performance.mark()` and `performance.measure()` for key operations\n\n## Implementation Notes\n\n### Web Audio API Precision\n\nThe core timing engine uses **look-ahead scheduling** pattern:\n1. Schedule beats ~100ms in advance using `AudioContext.currentTime`\n2. Use `setTimeout` to wake up scheduler every 25ms to check if more beats need scheduling\n3. This ensures beats are scheduled with audio-clock precision, not JavaScript timer precision\n\n**Why this matters**: JavaScript timers (`setTimeout`, `setInterval`) are not accurate enough for beat timing. They can drift by 10-50ms. Web Audio API's clock is sample-accurate.\n\n### State Persistence Strategy\n\n**localStorage Keys**:\n- `metronome_presets`: JSON array of all saved presets\n- `metronome_lastConfig`: JSON object of last-used configuration (auto-restored on load)\n- `metronome_settings`: UI preferences (panel collapsed, active tab)\n\n**Storage Limit Enforcement**:\n- Calculate approximate JSON size before saving\n- If size > 4.5MB (leave 0.5MB buffer), prompt user to delete presets\n- Validate parsed data matches TypeScript interfaces (runtime type checking)\n\n### Video Player Integration Pattern\n\nThe metronome subscribes to Video.js player events via the `useVideoPlayer` hook:\n\n```typescript\nuseEffect(() => {\n  if (!playerState.playerRef.current) return;\n\n  const player = playerState.playerRef.current;\n\n  const handlePlay = () => {\n    if (metronomeEnabled && !metronomeEngine.isRunning()) {\n      metronomeEngine.resume();\n    }\n  };\n\n  const handlePause = () => {\n    if (metronomeEngine.isRunning()) {\n      metronomeEngine.pause();\n    }\n  };\n\n  const handleSeeked = () => {\n    // Re-sync metronome beat position to video time\n    const currentBeat = calculateBeatFromTime(player.currentTime(), config.bpm);\n    metronomeEngine.seekToBeat(currentBeat);\n  };\n\n  player.on('play', handlePlay);\n  player.on('pause', handlePause);\n  player.on('seeked', handleSeeked);\n\n  return () => {\n    player.off('play', handlePlay);\n    player.off('pause', handlePause);\n    player.off('seeked', handleSeeked);\n  };\n}, [playerState.playerRef, metronomeEnabled, config.bpm]);\n```\n\n### CSS Animation Performance\n\nVisual effects use CSS transforms and opacity (GPU-accelerated) instead of width/height (triggers layout reflow):\n\n```css\n/* GOOD - GPU accelerated */\n.pulse-effect {\n  transform: scale(1);\n  opacity: 1;\n  transition: transform 0.3s ease-out, opacity 0.3s ease-out;\n}\n\n.pulse-effect.beat {\n  transform: scale(1.5);\n  opacity: 0;\n}\n\n/* BAD - triggers layout reflow */\n.pulse-effect-bad {\n  width: 100px;\n  height: 100px;\n  transition: width 0.3s, height 0.3s;\n}\n```\n\n### Type Safety Strategy\n\nAll metronome configurations use TypeScript discriminated unions for type-safe config handling:\n\n```typescript\n// Visual config discriminated by visualStyle\ntype VisualConfig =\n  | { visualStyle: 'flash'; color: string; opacity: number }\n  | { visualStyle: 'pulse'; color: string; opacity: number; shape: Shape; size: number }\n  | { visualStyle: 'border'; color: string; thickness: number }\n  | { visualStyle: 'none' }\n\n// TypeScript ensures only valid properties for each style\nfunction renderVisual(config: VisualConfig) {\n  switch (config.visualStyle) {\n    case 'pulse':\n      // TypeScript knows config.shape exists here\n      return <PulseEffect shape={config.shape} />\n    case 'flash':\n      // TypeScript knows config.shape does NOT exist here\n      return <FlashEffect color={config.color} />\n  }\n}\n```\n\n### Accessibility Considerations\n\n- All controls keyboard navigable (Tab order logical)\n- BPM slider has `aria-label` and `aria-valuemin`/`aria-valuemax`/`aria-valuenow`\n- Metronome state announced with `aria-live=\"polite\"` region\n- Visual effects have `aria-hidden=\"true\"` (decorative, not semantic)\n- Settings panel supports Escape key to close\n- Focus trapped within panel when open (modal behavior)\n\n### Browser Compatibility\n\n**Minimum Supported Versions**:\n- Chrome/Edge: 90+\n- Firefox: 88+\n- Safari: 14+\n\n**Feature Detection**:\n- `AudioContext` / `webkitAudioContext` fallback\n- `requestAnimationFrame` for visual effects\n- `localStorage` availability check\n- CSS Grid support for layout (graceful degradation to flexbox)\n\n**Polyfills**: None required (all target browsers support necessary APIs)\n",
  "fileStats": {
    "size": 38150,
    "lines": 1058,
    "lastModified": "2025-11-10T09:33:24.892Z"
  },
  "comments": []
}