#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "Running pre-commit hooks..."

# Check if backend files are staged
BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '^backend/.*\.ts$' || true)
if [ -n "$BACKEND_FILES" ]; then
  echo "Checking backend files..."

  # Run Prettier check
  echo "$BACKEND_FILES" | xargs npx prettier --check
  if [ $? -ne 0 ]; then
    echo "❌ Backend Prettier check failed. Run 'npm run format' to fix."
    exit 1
  fi

  # Run ESLint
  cd backend
  npm run lint
  LINT_RESULT=$?
  cd ..

  if [ $LINT_RESULT -ne 0 ]; then
    echo "❌ Backend ESLint check failed. Fix errors before committing."
    exit 1
  fi

  echo "✅ Backend checks passed"
fi

# Check if frontend files are staged
FRONTEND_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '^frontend/.*\.\(ts\|tsx\)$' || true)
if [ -n "$FRONTEND_FILES" ]; then
  echo "Checking frontend files..."

  # Run Prettier check
  echo "$FRONTEND_FILES" | xargs npx prettier --check
  if [ $? -ne 0 ]; then
    echo "❌ Frontend Prettier check failed. Run 'npm run format' to fix."
    exit 1
  fi

  # Run ESLint
  cd frontend
  npm run lint
  LINT_RESULT=$?
  cd ..

  if [ $LINT_RESULT -ne 0 ]; then
    echo "❌ Frontend ESLint check failed. Fix errors before committing."
    exit 1
  fi

  echo "✅ Frontend checks passed"
fi

echo "✅ All pre-commit checks passed!"
